<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Lobby MVP</title>
    <!-- Bootstrap для красоты -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        .chat-container { display: flex; height: 500px; border: 1px solid #ddd; }
        .chat-sidebar { width: 30%; border-right: 1px solid #ddd; padding: 10px; overflow-y: scroll; }
        .chat-main { width: 70%; display: flex; flex-direction: column; padding: 10px; }
        .chat-history { flex-grow: 1; overflow-y: scroll; border: 1px solid #eee; margin-bottom: 10px; padding: 5px; }
        .participant-item { padding: 5px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .status-online { color: green; font-weight: bold; font-size: 0.8em; }
        .status-offline { color: gray; font-size: 0.8em; }
    </style>
</head>
<body class="bg-light">

<div class="container mt-5">

    <!-- 1. Экран Логина -->
    <div id="login-screen" class="card p-4 mx-auto" style="max-width: 400px;">
        <h3 class="text-center">Вход</h3>
        <input type="text" id="username" class="form-control mb-2" placeholder="Ваше имя (Ник)">
        <button onclick="loginUser()" class="btn btn-primary w-100">Войти</button>
    </div>

    <!-- 2. Экран Лобби (Список комнат) -->
    <div id="lobby-screen" style="display: none;">
        <h3>Привет, <span id="lobby-username"></span>!</h3>
        <div class="row">
            <div class="col-md-4">
                <h5>Мои комнаты</h5>
                <ul id="my-rooms-list" class="list-group mb-3">
                    <!-- Сюда попадут комнаты -->
                </ul>
                <hr>
                <h5>Создать / Войти в новую</h5>
                <div class="input-group">
                    <input type="text" id="new-room-name" class="form-control" placeholder="Название комнаты">
                    <button onclick="joinRoom(document.getElementById('new-room-name').value)" class="btn btn-success">Go</button>
                </div>
            </div>
            <div class="col-md-8">
                <div class="alert alert-info">Выберите комнату слева или создайте новую.</div>
            </div>
        </div>
    </div>

    <!-- 3. Экран Чата -->
    <div id="chat-screen" style="display: none;">
        <div class="d-flex justify-content-between mb-2">
            <h4>Комната: <span id="current-room-name"></span></h4>
            <button onclick="leaveChat()" class="btn btn-sm btn-outline-danger">Назад в Лобби</button>
        </div>

        <div class="chat-container bg-white">
            <!-- Список участников (Sidebar) -->
            <div class="chat-sidebar">
                <h6>Участники</h6>
                <div id="participants-list">
                    <!-- JS заполнит это -->
                </div>
            </div>

            <!-- История сообщений -->
            <div class="chat-main">
                <div id="chat-history" class="chat-history"></div>
                <div class="input-group">
                    <input type="text" id="message-input" class="form-control" placeholder="Сообщение...">
                    <button onclick="sendMessage()" class="btn btn-primary">Send</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    const socket = io();
    let currentUser = '';
    let currentRoom = '';

    // --- ЛОГИН ---
    function loginUser() {
        const username = document.getElementById('username').value;
        if (!username) return alert("Введите имя!");
        currentUser = username;
        socket.emit('login', {username: currentUser});
    }

    socket.on('login_response', (data) => {
        if (data.success) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('lobby-screen').style.display = 'block';
            document.getElementById('lobby-username').innerText = currentUser;

            renderRoomList(data.rooms); // Используем общую функцию
        }
    });

    // --- ИСПРАВЛЕНИЕ 2: Обработка обновления списка комнат ---
    socket.on('update_room_list', (data) => {
        renderRoomList(data.rooms);
    });

    function renderRoomList(rooms) {
        const list = document.getElementById('my-rooms-list');
        list.innerHTML = '';
        if (rooms.length === 0) {
            list.innerHTML = '<li class="list-group-item text-muted">Нет активных чатов</li>';
            return;
        }
        rooms.forEach(room => {
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
            li.innerText = room.name;
            li.style.cursor = 'pointer';
            li.onclick = () => joinRoom(room.name);
            list.appendChild(li);
        });
    }

    // --- ВХОД В КОМНАТУ ---
    function joinRoom(roomNameInput) {
        const roomName = roomNameInput || document.getElementById('room-input').value;
        if (!roomName) return alert("Введите название комнаты!");

        currentRoom = roomName;

        document.getElementById('lobby-screen').style.display = 'none';
        document.getElementById('chat-screen').style.display = 'block';
        document.getElementById('current-room-name').innerText = currentRoom;

        // Очистка UI перед входом
        document.getElementById('chat-history').innerHTML = '';
        document.getElementById('participants-list').innerHTML = '';

        socket.emit('join_room_event', {username: currentUser, room: currentRoom});
    }

    function leaveChat() {
        // Мы не отключаемся от сокета, просто меняем UI и "выходим" из логической комнаты
        socket.emit('leave_room_event', {username: currentUser, room: currentRoom});
        document.getElementById('chat-screen').style.display = 'none';
        document.getElementById('lobby-screen').style.display = 'block';
        currentRoom = '';
    }

    // --- СООБЩЕНИЯ ---
    function sendMessage() {
        const input = document.getElementById('message-input');
        if(input.value) {
            socket.emit('send_message_event', {
                username: currentUser,
                room: currentRoom,
                message: input.value
            });
            input.value = '';
        }
    }

    document.getElementById('message-input').addEventListener("keypress", function(event) {
        if (event.key === "Enter") sendMessage();
    });

    socket.on('load_history', (history) => {
        const box = document.getElementById('chat-history');
        box.innerHTML = '';
        history.forEach(msg => appendMessage(msg));
        scrollToBottom();
    });

    socket.on('receive_message', (data) => {
        appendMessage(data);
        scrollToBottom();
    });

    // --- УЧАСТНИКИ И СТАТУСЫ ---

    socket.on('room_info', (data) => {
        const list = document.getElementById('participants-list');
        list.innerHTML = '';
        // Сортируем: Онлайн выше
        const sorted = data.participants.sort((a, b) => (a.status === 'online' ? -1 : 1));
        sorted.forEach(p => createOrUpdateParticipant(p));
    });

    // --- ИСПРАВЛЕНИЕ 1: Надежное обновление статуса ---
    socket.on('user_status_change', (data) => {
        console.log("Status change received:", data); // Для отладки в консоли браузера
        createOrUpdateParticipant(data);
    });

    function createOrUpdateParticipant(user) {
        const list = document.getElementById('participants-list');
        let el = document.getElementById(`user-${user.username}`);

        // Если элемента нет - создаем
        if (!el) {
            el = document.createElement('div');
            el.id = `user-${user.username}`;
            // Добавляем отступы (my-1) и рамку снизу
            el.className = 'participant-item p-2 border-bottom';
            list.appendChild(el);
        }

        // Логика HTML для статуса
        let statusHtml = '';
        if (user.status === 'online') {
            // Зеленый бейдж
            statusHtml = `<span class="badge bg-success" style="font-weight: normal;">Online</span>`;
        } else {
            // Серая надпись
            statusHtml = `<span class="text-muted" style="font-size: 0.85em;">
                Last seen: ${user.last_seen || 'N/A'}
            </span>`;
        }

        // ВЕРТИКАЛЬНАЯ ВЕРСТКА:
        // div для имени, div для статуса. Никакого наложения.
        el.innerHTML = `
            <div class="d-flex flex-column">
                <div class="fw-bold text-truncate" style="max-width: 100%;" title="${user.username}">
                    ${user.username}
                </div>
                <div class="mt-1">
                    ${statusHtml}
                </div>
            </div>
        `;
    }

    // --- ВСПОМОГАТЕЛЬНЫЕ ---

    function appendMessage(data) {
        const box = document.getElementById('chat-history');
        const isMe = data.sender === currentUser;

        const wrapper = document.createElement('div');
        wrapper.style.textAlign = isMe ? 'right' : 'left';
        wrapper.style.marginBottom = '8px';

        const bubble = document.createElement('div');
        bubble.style.display = 'inline-block';
        bubble.style.padding = '8px 12px';
        bubble.style.borderRadius = '12px';
        bubble.style.maxWidth = '75%';
        bubble.style.background = isMe ? '#007bff' : '#f1f1f1';
        bubble.style.color = isMe ? '#fff' : '#000';
        bubble.style.textAlign = 'left';

        bubble.innerHTML = `
            <div style="font-size: 0.7em; opacity: 0.7; margin-bottom: 2px;">${data.sender} • ${data.time}</div>
            <div>${data.text}</div>
        `;

        wrapper.appendChild(bubble);
        box.appendChild(wrapper);
    }

    function scrollToBottom() {
        const box = document.getElementById('chat-history');
        box.scrollTop = box.scrollHeight;
    }
</script>

</body>
</html>